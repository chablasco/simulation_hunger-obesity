<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CB Hunger & Obesity Stats</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
    }
    @font-face {
      font-family: 'CooperHewittThin';
      src: url('assets/CooperHewitt-Thin.otf') format('opentype');
    }
  </style>
</head>
<body>
<script>
let hungerDeaths = 0;
let localObesePeople = 0;
let globalObesePeople = 0;

let lastHungerUpdate = 0;
let hungerInterval = 3500;

let lastLocalObeseUpdate = 0;
let localObeseInterval = 1200;

let customFont;
let fontReady = false;

function preload() {
  customFont = loadFont('assets/CooperHewitt-Thin.otf', () => fontReady = true, () => fontReady = false);
}

function setup() {
  createCanvas(windowWidth, windowHeight);
  textAlign(CENTER, CENTER);
  noCursor();

  hungerDeaths = getInitialHungerDeaths();

  // Load local counter or start from 1,000,000
  const stored = localStorage.getItem("obeseLocalCounter");
  if (stored) {
    localObesePeople = parseInt(stored);
  } else {
    localObesePeople = 1000000;
    localStorage.setItem("obeseLocalCounter", localObesePeople.toString());
  }

  // Calculate global counter
  globalObesePeople = calculateGlobalObesityCount();
}

function draw() {
  background(0);
  if (fontReady) textFont(customFont);
  else textFont('monospace');

  const now = millis();

  if (now - lastHungerUpdate > hungerInterval) {
    hungerDeaths++;
    lastHungerUpdate = now;
  }

  if (now - lastLocalObeseUpdate > localObeseInterval) {
    localObesePeople++;
    localStorage.setItem("obeseLocalCounter", localObesePeople.toString());
    lastLocalObeseUpdate = now;
  }

  // Update global obese people in real time
  globalObesePeople = calculateGlobalObesityCount();

  const minSize = min(width, height);
  const numberSize = minSize * 0.10;
  const subtextSize = minSize * 0.038;
  const lineSpacing = minSize * 0.035;
  const blockSpacing = minSize * 0.07;

  const totalHeight = 3 * (numberSize + subtextSize + lineSpacing) + 2 * blockSpacing;
  const topY = (height - totalHeight) / 2;

  fill(255);
  textSize(numberSize);
  text(formatNumber(hungerDeaths), width / 2, topY + numberSize / 2);
  fill(160);
  textSize(subtextSize);
  text("people have died of hunger today", width / 2, topY + numberSize + lineSpacing + subtextSize / 2);

  const secondY = topY + numberSize + subtextSize + lineSpacing + blockSpacing;

  fill(255);
  textSize(numberSize);
  text(formatNumber(globalObesePeople), width / 2, secondY + numberSize / 2);
  fill(160);
  textSize(subtextSize);
  text("estimated global number of obese people", width / 2, secondY + numberSize + lineSpacing + subtextSize / 2);

  const thirdY = secondY + numberSize + subtextSize + lineSpacing + blockSpacing;

  fill(255);
  textSize(numberSize);
  text(formatNumber(localObesePeople), width / 2, thirdY + numberSize / 2);
  fill(160);
  textSize(subtextSize);
  text("your local counter (stored in this device)", width / 2, thirdY + numberSize + lineSpacing + subtextSize / 2);
}

function getInitialHungerDeaths() {
  const now = new Date();
  const secondsSinceMidnight = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
  return Math.floor(secondsSinceMidnight / 3.5);
}

// Real-time global counter based on Jan 1, 2025 start
function calculateGlobalObesityCount() {
  const base = 1_000_000_000;
  const startTime = new Date("2025-01-01T00:00:00Z").getTime();
  const now = Date.now();
  const elapsedSeconds = Math.floor((now - startTime) / 1000);
  return base + Math.floor(elapsedSeconds / 1.2);
}

function formatNumber(n) {
  return n.toLocaleString('en').replace(/,/g, ' ');
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}
</script>
</body>
</html>
